{% extends "base/_base.html" %}
{% block title %}
    {% if ordem %}Editar Ordem de Serviço{% else %}Nova Ordem de Serviço{% endif %}
{% endblock %}
{% block content %}

    <h1 style="text-align: center;">
        {% if ordem %}EDITAR ORDEM DE SERVIÇO{% else %}CRIAR NOVA ORDEM DE SERVIÇO{% endif %}
    </h1>

    {% if error_message %}
        <p class="error-message" style="color: var(--color-accent); text-align: center; font-weight: bold; margin-bottom: 20px; border: 1px solid var(--color-accent); padding: 15px;">
            ERRO: {{ error_message }}
        </p>
    {% endif %}

    <form method="post">
        {% csrf_token %}

        {# Seleção de Veículo (Placa como PK) #}
        <div class="form-group">
            <select id="veiculo" name="veiculo" required>
                <option value="">Selecione um Veículo</option>
                {% for v in veiculos %}
                    <option value="{{ v.placa }}" {% if ordem.veiculo.pk == v.placa %}selected{% endif %}>
                        {{ v.placa }} ({{ v.modelo }} - Cliente: {{ v.cliente.nome }})
                    </option>
                {% endfor %}
            </select>
            <label for="veiculo">Veículo:</label>
        </div>

        {# Seleção de UM Serviço (ForeignKey) #}
        <div class="form-group">
            <select id="servico_principal" name="servico_principal" required>
                <option value="">Selecione o Serviço Principal</option>
                {% for s in servicos_disponiveis %}
                    <option value="{{ s.pk }}" {% if ordem.servico.pk == s.pk %}selected{% endif %}>
                        {{ s.descricao }} (R$ {{ s.preco|stringformat:"%.2f" }})
                    </option>
                {% endfor %}
            </select>
            <label for="servico_principal">Serviço Principal:</label>
        </div>

        {# Kilometragem #}
        <div class="form-group">
            <input type="number" id="Kilometragem" name="Kilometragem" value="{{ ordem.Kilometragem|default:'' }}" placeholder="Quilometragem do Veículo" required>
            <label for="Kilometragem">Kilometragem:</label>
        </div>

        {# Data de Saída (dataEntrada é automático) #}
        <div class="form-group">
            <input type="date" id="dataSaida" name="dataSaida" value="{{ ordem.dataSaida|date:'Y-m-d'|default:'' }}">
            <label for="dataSaida">Data de Saída (Opcional):</label>
        </div>

        {# Valor Total #}
        <div class="form-group">
            <input type="number" id="valorTotal" name="valorTotal" value="{{ ordem.valorTotal|default:'0.00' }}" placeholder="Valor Total da Ordem de Serviço (R$)" step="0.01">
            <label for="valorTotal">Valor Total:</label>
        </div>
        
        {# Feito (Checkbox) #}
        <div class="form-group checkbox-group">
            <input type="checkbox" id="feito" name="feito" {% if ordem.feito %}checked{% endif %}>
            <label for="feito">Serviço Concluído?</label>
        </div>

        <h2 style="margin-top: 30px; text-align: center;">Peças Utilizadas</h2>

<div id="pecaListaContainer">
    {% for pecaUsada in ordem.pecausada_set.all|default_if_none:'' %}
        <div class="form-group peca-item">
            <input type="hidden" name="pecaUsadaPk" value="{{ pecaUsada.pk }}">
            
            <label for="pecaId">Peça:</label>
            <select name="pecaId" required>
                <option value="">Selecione uma Peça</option>
                {% for peca in pecas_disponiveis %}
                    <option value="{{ peca.pk }}" {% if pecaUsada.peca.pk == peca.pk %}selected{% endif %}>
                        {{ peca.nome }} (Estoque: {{ peca.quantidade }})
                    </option>
                {% endfor %}
            </select>
            
            <label for="quantidadeUsada">Quantidade:</label>
            <input type="number" name="quantidadeUsada" value="{{ pecaUsada.quantidadeUsada }}" min="1" required style="width: 100px; display: inline-block;">
            
            <button type="button" class="remover-peca-btn" style="margin-left: 10px;">Remover</button>
        </div>
    {% empty %}
        <div class="form-group peca-item" id="pecaModelo">
            <input type="hidden" name="pecaUsadaPk" value="">
            
            <label for="pecaId">Peça:</label>
            <select name="pecaId">
                <option value="">Selecione uma Peça</option>
                {% for peca in pecas_disponiveis %}
                    <option value="{{ peca.pk }}">{{ peca.nome }} (Estoque: {{ peca.quantidade }})</option>
                {% endfor %}
            </select>
            
            <label for="quantidadeUsada">Quantidade:</label>
            <input type="number" name="quantidadeUsada" value="1" min="1" style="width: 100px; display: inline-block;">
            
            <button type="button" class="remover-peca-btn" style="margin-left: 10px; display: none;">Remover</button>
        </div>
    {% endfor %}
</div>

<button type="button" id="adicionarPecaBtn" style="margin-top: 15px;">+ Adicionar Peça</button>
        
        <div class="form-submit-group">
            <button type="submit">Salvar Ordem de Serviço</button>
        </div>
    </form>






    <script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('pecaListaContainer');
    const modelo = document.getElementById('pecaModelo');
    const addButton = document.getElementById('adicionarPecaBtn');
    if (modelo) {
        modelo.style.display = 'block';
    }

    function adicionarPeca() {
        const linhaBase = container.lastElementChild;
        const novaPecaItem = linhaBase.cloneNode(true);

        novaPecaItem.querySelector('input[name="pecaUsadaPk"]').value = '';
        novaPecaItem.querySelector('select[name="pecaId"]').value = ''; // Limpa a seleção
        novaPecaItem.querySelector('input[name="quantidadeUsada"]').value = '1'; // Define como 1

        const removeBtn = novaPecaItem.querySelector('.remover-peca-btn');
        if (removeBtn) {
            removeBtn.style.display = 'inline-block';
        }

        container.appendChild(novaPecaItem);
        novaPecaItem.querySelector('.remover-peca-btn').addEventListener('click', function() {
            novaPecaItem.remove();
        });
    }

    addButton.addEventListener('click', adicionarPeca);
    document.querySelectorAll('.remover-peca-btn').forEach(button => {
        button.addEventListener('click', function() {
            button.closest('.peca-item').remove();
        });
    });
});
</script>
{% endblock %}