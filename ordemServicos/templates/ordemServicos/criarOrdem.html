{% extends "base/_base.html" %}
{% block title %}
    {% if ordem %}Editar Ordem de Serviço{% else %}Nova Ordem de Serviço{% endif %}
{% endblock %}
{% block content %}

    <h1 style="text-align: center;">
        {% if ordem %}EDITAR ORDEM DE SERVIÇO{% else %}CRIAR NOVA ORDEM DE SERVIÇO{% endif %}
    </h1>

    {% if error_message %}
        <p class="error-message" style="color: var(--color-accent); text-align: center; font-weight: bold; margin-bottom: 20px; border: 1px solid var(--color-accent); padding: 15px;">
            ERRO: {{ error_message }}
        </p>
    {% endif %}

    <form method="post">
        {% csrf_token %}

        {# Seleção de Veículo (Placa como PK) #}
        <div class="form-group">
            <select id="veiculo" name="veiculo" required>
                <option value="">Selecione um Veículo</option>
                {% for v in veiculos %}
                    <option value="{{ v.placa }}" {% if ordem.veiculo.pk == v.placa %}selected{% endif %}>
                        {{ v.placa }} ({{ v.modelo }} - Cliente: {{ v.cliente.nome }})
                    </option>
                {% endfor %}
            </select>
            <label for="veiculo">Veículo:</label>
        </div>

        {# Seleção de UM Serviço (ForeignKey) #}
        <div class="form-group">
            <select id="servico_principal" name="servico_principal" required>
                <option value="">Selecione o Serviço Principal</option>
                {% for s in servicos_disponiveis %}
                    <option value="{{ s.pk }}" {% if ordem.servico.pk == s.pk %}selected{% endif %}>
                        {{ s.descricao }} (R$ {{ s.preco|stringformat:"%.2f" }})
                    </option>
                {% endfor %}
            </select>
            <label for="servico_principal">Serviço Principal:</label>
        </div>

        {# Kilometragem #}
        <div class="form-group">
            <input type="number" id="Kilometragem" name="Kilometragem" value="{{ ordem.Kilometragem|default:'' }}" placeholder="Quilometragem do Veículo" required>
            <label for="Kilometragem">Kilometragem:</label>
        </div>

        {# Data de Saída (dataEntrada é automático) #}
        <div class="form-group">
            <input type="date" id="dataSaida" name="dataSaida" value="{{ ordem.dataSaida|date:'Y-m-d'|default:'' }}">
            <label for="dataSaida">Data de Saída (Opcional):</label>
        </div>

        {# Valor Total #}
        <div class="form-group">
            <input type="number" id="valorTotal" name="valorTotal" value="{{ ordem.valorTotal|default:'0.00' }}" placeholder="Valor Total da Ordem de Serviço (R$)" step="0.01">
            <label for="valorTotal">Valor Total:</label>
        </div>
        
        {# Feito (Checkbox) #}
        <div class="form-group checkbox-group">
            <input type="checkbox" id="feito" name="feito" {% if ordem.feito %}checked{% endif %}>
            <label for="feito">Serviço Concluído?</label>
        </div>

        {# Seleção de Múltiplas Peças (ManyToManyField) #}
        <div class="form-group">
            <select id="pecas" name="pecas" multiple size="5">
                <option value="" disabled>Selecione as Peças (Ctrl/Cmd + clique)</option>
                {% for peca in pecas_disponiveis %}
                    <option value="{{ peca.pk }}"
                            {% if pecas_selecionadas_pk and peca.pk in pecas_selecionadas_pk %}selected{% endif %}>
                        {{ peca.nome }} (R$ {{ peca.valorUN|stringformat:"%.2f" }} - Estoque: {{ peca.quantidade }})
                    </option>
                {% endfor %}
            </select>
            <label for="pecas">Peças Utilizadas:</label>
        </div>
        
        <div class="form-submit-group">
            <button type="submit">Salvar Ordem de Serviço</button>
        </div>
    </form>

{% endblock %}